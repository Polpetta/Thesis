% PROGETTAZIONE E CODIFICA

\chapter{Progettazione e codifica}

\section{Progettazione ed implementazione delle API}

\subsection{Descrizione dell'architettura}

Dato l'utilizzo dell'architettura \textit{serverless}, non si è applicato nella
scrittura delle API alcun tipo particolare di \textit{pattern}. L'architettura
di tipo \textit{serverless} infatti definisce in modo chiaro la delegazione
delle varie responsabilità a componenti molto piccoli e ben definiti. Questo
inoltre permette di avere tempi di risposta molto brevi.
La parte dedicata alla interazione con gli utenti è stata chiamata
\textit{webhook} a livello progettuale, per distinguerla dalle API.

\subsection{Descrizione delle API}
Come già accennato nella sezione \ref{prj:serverless:api}, le funzionalità più
importanti sono state suddivise in differenti API, ognuna delle quali risiede
in una propria istanza di AWS Lambda.

Comparando questa architettura con un classico pattern \textbf{MVC}, queste API
corrisponderebbero al \textit{Model}, che si occupa di gestire parti della
logica della applicazione. Essendo queste parti costituite da una sola
responsabilità e con un solo compito, la loro implementazione si è
concretizzata nella realizzazione di una sola classe per API.

\section{Descrizione del \textit{webhook}}
La parte dedicata all'interazione con gli utenti è stata realizzata sempre
usando l'architettura \textit{serverless}, ma essendo la sua complessità
maggiore la strutturazione a classi è stata necessaria al fine di mantenere una
facile comprensione del programma e una buona estendibilità. Tuttavia, per la
natura del servizio che PastBot ricopre, si è scelto di usare una modellazione
ad eventi per gestire le richieste provenienti dalla piattaforma Facebook
Messenger. In base agli eventi che vengono gestiti PastBot si occupa di fare le
chiamate alle API corrette. Comparandolo con il pattern di tipo \textbf{MVC},
\textit{webhook} si occupa di ricoprire la \textit{View} e il
\textit{Controller}.

\section{Descrizione delle classi}
Di seguito si eseguirà una descrizione delle classi più significative che
compongono PastBot e le relative API, suddivise in base alla componente alla
quale appartengono.

\begin{figure}[H]
  \centering
  \includegraphics[scale=0.5]{design/overallDesign}
  \caption{Design generale dell'applicazione}
\end{figure}

\subsection{API}

Le classi che appartengono a questa componente hanno lo scopo di eseguire le
operazioni sulle base di dati di PastBot. Avendo uno solo scopo e una sola
responsabilità, son risultate di facile progettazione.
Per evitare ripetizioni, è riportato qui uno schema generico di una classe:

\begin{figure}[H]
  \centering
  \includegraphics[scale=0.6]{design/singleAPI}
  \caption{Rappresentazione UML di una API}
\end{figure}

\label{design:api:params}
È importante segnalare come il servizio Amazon AWS Lambda passi sempre tre
parametri al metodo che andrà a invocare. Questi metodi sono:
\begin{itemize}
  \item \textbf{event}: è un oggetto in formato JSON che contiene i campi
dell'evento che viene inviato alla funzione lambda. Questi campi possono essere
definiti in maniera specifica tramite APIGateway.
  \item \textbf{context}: AWS Lambda usa questo parametro al fine di poter
ottenere informazioni a tempo di esecuzione sul tipo di funzione lambda che si
sta eseguendo.
  \item \textbf{callback}: tramite questo parametro è possibile, se necessario,
ritornare dati (in formato JSON) al chiamante o segnalare uno stato di errore
durante l'esecuzione. Essendo questo parametro opzionale, se non se ne farà uso
la risposta che si otterrà sarà un valore nullo.
\end{itemize}

\subsection{api::putPastBotCollectionPhoto}

Questa classe si occupa di aggiungere le foto inviate dall'Utente direttamente
nel database di PastBot. Essendo la \textit{privacy} un argomento molto
importante quando si trattano i dati personali degli utenti, le foto vengono
salvate indirettamente tramite il servizio \textit{Filestack}. Questo
servizio di salvataggio dati ha permesso una facile gestione dei dati degli
utenti, compreso il caricamento. Il caricamento della foto avviene inviando
l'indirizzo dell'allegato fornito da Facebook Messenger direttamente al
servizio \textit{Filestack}.


Questa classe per funzionare necessita del modulo nativo aggiuntivo
\textit{https}.

\subsection{api::getPastBotUser}

Questa classe si occupa di ritornare al chiamante le informazioni sull'utente
richieste. Viene eseguita quindi una interrogazione del database degli utenti,
in cui verrà cercato l'\textit{id} fornito nell'oggetto della richiesta. Se
l'utente viene trovato, verranno ritornate le informazioni su di esso e la
lista degli album (denominati anche \textit{collection}) creati da quell'utente
tramite il bot.
Se l'utente non è presente nella base di dati viene ritornato nell'oggetto uno
stato di errore.

\subsection{api::getPastBotCollection}

Questa classe ritorna le informazioni sull'ultimo album attivo. È necessario
fornire l'\textit{id} dell'utente per poter ottenere l'informazione.
Se viene fornito un \textit{id} non valido o non presente nella base di dati di
PastBot verrà ritornato nell'oggetto di ritorno uno stato di errore.

\subsection{api::createPastBotUser}

La classe accetta un nuovo utente e si occupa di aggiungerlo alla lista
degli utenti presenti nella base di dati di PastBot. È necessario passare un
identificativo che sia univoco per quell'utente. Se viene passato un
identificativo che è già presente nella base di dati la classe si occuperà di
ritornare al chiamante uno stato di errore.

\subsection{api::deletePastBotCollectionPhoto}

La classe si occupa di cancellare tutte le foto presenti all'interno di un
album dato. La cancellazione sancisce l'eliminazione completa dai database di
PastBot.
Lo stato della cancellazione viene riportato nell'oggetto che verrà ritornato
al chiamante.

\subsection{api::addPastBotMessage}

Questa classe ha l'incarico di salvare il messaggio ricevuto nella base di
dati. Questa funzione serve in futuro a PastBook per poter eseguire raccolta
dati e studi su di essi.

\subsection{api::createPastBotCollection}

La responsabilità di questa classe è quella di creare un nuovo album dato un
utente esistente. Se l'identificativo dell'utente non è valido verrà ritornato
un messaggio di errore, altrimenti verrà creato un nuovo album, che porterà a
sua volta un identificativo univoco.

\subsection{\textit{Webhook}}

Le classi all'interno di questo componente si occupano di gestire l'intera
interazione con gli utenti, dalla ricezione del messaggio fino alla loro
risposta. Le operazioni relative al salvataggio e recupero di informazioni sono
effettuate tramite le API, creando quindi un livello di indirettezza e una
maggiore estendibilità.
Il nome \textit{webhook} è stato dato per differenziare il bot dalle API.
Essendo infatti il bot scritto con le stesse tecnologie delle API si è dovuto
porre una differenza a livello di nome, per evitare incomprensioni.

\begin{figure}[H]
  \centering
  \includegraphics[scale=0.3]{design/processFacebookMessengerCallback}
  \caption{Diagramma delle classi per la parte di PastBot relativa
all'interazione con gli utenti.}
\end{figure}

Messenger attua una politica di concatenazione dei messaggi in arrivo: se un
utente invia per esempio due messaggi in rapida successione, viene generato un
solo evento, che conterrà un \textit{array} di messaggi inviati dall'utente. È
quindi stato creato inizialmente una classe \textbf{EntryProcessor} la quale si
occupa di ricevere l'evento e di estrarne i messaggi in esso contenuto. I
messaggi vengono posti in una coda di esecuzione, che viene "eseguita" quando
tutti i messaggi vengono estratti dall'evento.
Questa coda viene quindi passata alla classe \textbf{MessagingEventProcessor},
che si occupa di elaborare singolarmente e in maniera asincrona ogni messaggio
presente nella lista. In questa maniera, vengono gestite diversi eventi nello
stesso tempo di esecuzione, velocizzando il tempo di risposta e diminuendo il
tempo di attesa dell'utente. Un svantaggio di questa scelta è che le richieste,
essendo processate in maniera indipendente, possono venire ritornate in maniera
non ordinata. Si è comunque scelto di mantenere un approccio asincrono in
quanto è stato ritenuto più importante avere una buona velocità di risposta.

Per ogni messaggio ottenuto si identifica il tipo di messaggio, e in base al
tipo di messaggio viene chiamato il metodo adatto.
I tipi di messaggi che l'utente può inviare su Messenger sono i seguenti:
\begin{itemize}
  \item Messaggio di testo
  \item \textit{Sticker}
  \item Allegati
\end{itemize}
I messaggi di testo vengono ulteriormente analizzati nel metodo
\textbf{processText} che invidua specificatamente il tipo di comando che
l'utente ha mandato. Questa sezione è stata studiata in maniera tale che in
futuro possa essere utilizzato un sistema per interpretare il linguaggio
artificiale, in maniera tale da avere una miglior gestione delle richieste
effettuate dagli utenti.

Il meotodo \textbf{processASyncAttachments} si occupa dell'invio delle foto
alla rispettiva API. L'invio delle foto viene effettuato in maniera asincrona
tramite l'utilizzo della classe \textit{Promise} messa a disposizione dal
linguaggio JavaScript. Vengono effettuate multiple chiamate alla stessa API
tramite la classe \textbf{PastBookAPI}, che si occupa di prendere le immagini
inviate dall'utente e inoltrarle alle API messe a disposizione dal servizio di
salvataggio file \textit{Filestorage}.
L'allegato non viene direttamente inviato al bot. Messenger infatti invia l'URL
dell'allegato. Questo permette di velocizzare ulteriormente le operazioni, in
quanto si manipola una stringa di testa e non un file binario che potrebbe
pesare diversi \textit{MegaByte}.

\paragraph*{La classe Messaging} Questa classe si occupa di inviare i messaggi
in risposta all'utente. Per effettuare questa operazione si utilizza la classe
\textbf{FBMessenger}, che permette in questa maniera di fornire un ulteriore
livello di indirettezza. Le classi \textbf{ButtonAdder} e \textbf{Utils} sono
state create per dividere le responsabilità presenti nella classe classe
\textbf{Messaging}. \textbf{ButtonAdder} si occupa della creazione e
resistuzione dei bottoni grafici che poi verranno visualizzati dagli utenti.
Questi bottoni devono essere degli oggetti di tipo JSON che seguano quanto
specificato dalla documentazione di Messenger.
\textbf{Utils} contiene un metodo per ottenere il numero di foto presenti in un
album. Questo metodo è stato utilizzato soprattutto per operazioni di conteggio.

% FIXME: la freccia nel diagramma ha direzione opposta, da correggere.
\paragraph*{La classe FBMessenger} La responsabilità di questa classe è, come
già accennato, quella di inviare i messaggi agli utenti. Il metodo
\textbf{send} si occupa di inviare i dati alle API di Messenger. Tutti gli
altri metodo impostano i dati da inviare, contenendo il testo del messaggio in
base alla richiesta dell'utente.


% TODO: le statistiche di dashbot dove vanno?
